# IO多路复用

## 概念



IO多路复用是指内核一旦发现进程指定一个或者多个IO条件准备读取，它就通知该进程，IO多路复用适用如下场合

1. 当客户处理多个描述符(一般是交互式输入和网络套接口)必须使用IO复用
2. 如果一个TCP服务器既要处理监听套接口，又要处理已连接套接口
3. 一个服务器既要处理TCP，又要处理UDP
4. 一个服务器要处理多个服务和多个协议
   
## 和多进程和多线程技术相比

I/O多路复用技术的最大优势是系统开销小，系统不必创建进程/线程 ，也不必维护它们，从而大大减小了系统的开销

## 支持的系统调用
- select
- pselect
- poll
- epoll
通过一种机制，一个进程可以监视多个描述符，一旦某个描述符就绪(一般是读就绪或者写就绪)，能够通知程序进行相应的读写操作，但select,pselect,poll,epoll本质上都是同步I/O，因为他们都需要在读写事件就绪后自己负责进行读写，也就是说这个读写过程是阻塞的，而异步I/O则无需自己负责进行读写，异步I/O的实现会负责把数据从内核拷贝到用户空间

## select,poll,epoll简介
epoll和select都能提供多路I/O复用的解决方案，在现在的linux内核里都有，其中epoll是linux特有的，而select则应该是POSIX所规定的

### select
在一段时间内，监听用户感兴趣的文件描述符上的可读，可写和异常等事件

### poll
和select类似，也是在指定时间内轮询一定数量的文件描述符，以测试其中是否有就绪者

### epoll
使用一组函数来完成任务的，epoll把用户关心的文件描述符上的时间放在内核里的一个时间表中，从而无需像select和poll那样每次调用都要重复传入文件描述符集或事件集，但epoll需要使用一个额外的文件描述符来唯一标识内核中的这个事件表

## 区别

这三组系统调用都能同时监听多个文件描述符，将等待由timeout参数指定的超时时间，直到一个或者多个文件描述符上有事件发生时返回，返回值是就绪的文件描述符

至于区别：

1. 事件集
   1. 三组函数都通过某个结构体变量来告诉内核监听哪些文件描述符上的哪些事件，并使用该结构体类型的参数来获取内核处理的结果，select的参数类型fd_set没有将文件描述符和事件绑定，仅仅是一个文件描述符集合，因此需要提供三种类型的参数分别传入和输出三类事件，这使得其不能处理更多类型的事件，poll的参数类型pollfd将文件描述符和事件都定义在其中，任何事件都被统一处理，从而使得编程接口变得简洁得多，并且内核每次修改的是pollfd结构体的revents成员，而events成员保持，由于每次select和poll调用都返回整个用户注册的事件集合（就绪和没就绪的）,epoll则采用在内核维护一个事件表，并提供一个独立的系统调用epoll_ctl来控制往其中添加，删除，修改事件，这样每次epoll_wait调用都直接从内核事件表中取得用户注册的事件，而无需从用户空间读入这些事件
2. 最大支持文件描述符数
   1. poll和epoll都能达到系统允许打开的最大文件描述符数目65535而select至于1024
3. 工作模式
   1. select 和poll都为LT,epoll支持ET
4. 具体实现
   1. poll select采用轮询的方式o(n)，epoll采用回调的方式O(1)