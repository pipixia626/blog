# linux 文件系统

## 文件系统的组成
一切皆文件
linux文件系统会为每个文件分配两个数据结构：索引节点和目录项，主要用来记录文件的元信息和目录层次结构

1. 索引节点 ：记录文件的元信息
   1. 节点ID
   2. 文件大小
   3. 访问权限
   4. 创建时间
   5. 修改时间
   6. 数据在磁盘位置
2. 目录项：记录文件的名字，索引节点指针以及于其他目录项的层级关联关系
   1. 由内核维护的一个数据结构，不存放于磁盘，而是缓存在内存
   
### 文件数据如何存储在磁盘
磁盘读写最小单位是扇区，扇区的大小只有512B大小，吧多个扇区组成了一个逻辑块，每次读写的最小单位是逻辑块,linux为4kb，也就是8个扇区，这将大大提高了磁盘的读写效率


### 磁盘的存储区域
超级块：用来存储文件系统的详细信息，比如块个数、块大小、空闲块
索引节点区：存储索引节点
数据块区：用来存储文件和目录数据
## 虚拟文件系统
文件系统的种类众多，而操作希望对用户提供一个统一的接口，于是在用户层和文件系统层引入了中间层，这个中间层就称为虚拟文件系统VFS
## 文件的使用
我们打开了一个文件后，操作系统会跟踪进程打开的所有文件，所谓的跟踪呢，就是操作系统为每个进程维护一个打开文件表，文件表里的每一项代表「文件描述符」，所以说文件描述符是打开文件的标识。
### 文件表维护打开文件的状态和信息
1. 文件指针：系统跟踪上次读写位置作为当前文件位置指针，这种指针对打开文件的某个进程来说是唯一的；
2. 文件打开计数器：文件关闭时，操作系统必须重用其打开文件表条目，否则表内空间不够用。因为多个进程可能打开同一个文件，所以系统在删除打开文件条目之前，必须等待最后一个进程关闭文件，该计数器跟踪打开和关闭的数量，当该计数为 0 时，系统关闭文件，删除该条目；
3. 文件磁盘位置：绝大多数文件操作都要求系统修改文件数据，该信息保存在内存中，以免每个操作都从磁盘中读取；
4. 访问权限：每个进程打开文件都需要有一个访问模式（创建、只读、读写、添加等），该信息保存在进程的打开文件表中，以便操作系统能允许或拒绝之后的 I/O 请求；

## 文件的存储
### 连续空间存放方式
文件头里需要指定「起始块的位置」和「长度」
缺点：
1. 有磁盘空间碎片
2. 文件长度不易扩展
### 非连续空间存放方式
1. 链表
2. 索引

## 空闲空间管理
保存数据块的时候，选择磁盘哪个位置
### 空闲表法
为所有空闲空间建立一张表，表内容包括空闲区的第一个块号和该空闲块数
### 空闲链表法
我们也可以使用「链表」的方式来管理空闲空间，每一个空闲块里有一个指针指向下一个空闲块，这样也能很方便的找到空闲块并管理起来。

这种技术只要在主存中保存一个指针，令它指向第一个空闲块。其特点是简单，但不能随机访问，工作效率低，因为每当在链上增加或移动空闲块时需要做很多 I/O 操作，同时数据块的指针消耗了一定的存储空间。

空闲表法和空闲链表法都不适合用于大型文件系统，因为这会使空闲表或空闲链表太大。
### 位图法
利用二进制的一位来表示磁盘中一个盘块的使用情况
## 文件系统的结构

块组概念
超级块，包含的是文件系统的重要信息，比如 inode 总个数、块总个数、每个块组的 inode 个数、每个块组的块个数等等。
块组描述符，包含文件系统中各个块组的状态，比如块组中空闲块和 inode 的数目等，每个块组都包含了文件系统中「所有块组的组描述符信息」。
数据位图和 inode 位图， 用于表示对应的数据块或 inode 是空闲的，还是被使用中。
inode 列表，包含了块组中所有的 inode，inode 用于保存文件系统中与各个文件和目录相关的所有元数据。
数据块，包含文件的有用数据。

## 目录的存储

### 列表

### 哈希表

## 软链接和硬链接
## 文件I/O
就是操作系统I/O操作
